---
- name: Déployer l'API
  hosts: api
  become: true
  vars:
      NODEJS_VERSION: "22"

  tasks:
    - name: Installer les paquets nécessaires (git, curl)
      apt:
        name:
          - git
          - curl
        update_cache: yes

    - name: Ajouter la clé GPG officielle de NodeSource
      apt_key:
        url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
        state: present

    - name: Ajouter le dépôt Node.js {{ NODEJS_VERSION }}.x
      apt_repository:
        repo: "deb https://deb.nodesource.com/node_{{ NODEJS_VERSION }}.x {{ ansible_distribution_release | lower }} main"
        state: present
        update_cache: yes

    - name: Installer Node.js {{ NODEJS_VERSION }}
      apt:
        name: nodejs
        state: present

    - name: Vérifier la version installée de Node.js
      shell: node -v
      register: node_version_output
      changed_when: false

    - name: Afficher la version installée
      debug:
        var: node_version_output.stdout

    - name: Cloner le dépôt API
      git:
        repo: 'https://github.com/Projet-CI-CD/API.git'
        dest: /home/lennytooxikx/api
        update: yes

    - name: Donner les droits à l'utilisateur lennytooxikx
      file:
        path: /home/lennytooxikx/api
        owner: lennytooxikx
        group: lennytooxikx
        recurse: yes

    - name: Installer les dépendances Node.js
      become_user: lennytooxikx
      args:
        chdir: /home/lennytooxikx/api
      shell: |
        npm install

    - name: Lancer l'API avec npm start (en arrière-plan)
      become_user: lennytooxikx
      args:
        chdir: /home/lennytooxikx/api
      shell: |
        nohup npm start > app.log 2>&1 &

    - name: Vérifier le log de démarrage
      become_user: lennytooxikx
      shell: tail -n 10 /home/lennytooxikx/api/app.log || echo "Log vide ou inexistant"
